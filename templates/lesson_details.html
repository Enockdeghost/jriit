{% extends "base_att.html" %}

{% block title %}lesson details{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar {
        background-color: #2c3e50 !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .navbar-brand {
        font-weight: 700;
        color: #ecf0f1 !important;
    }
    .card {
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .status-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }
    .qr-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .qr-code {
        max-width: 300px;
        width: 100%;
        height: auto;
        border: 3px solid #3498db;
        border-radius: 10px;
        background: white;
        padding: 1rem;
    }
    .attendance-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
    }
    .table thead th {
        background-color: #3498db;
        color: white;
        border: none;
        font-weight: 600;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f8f9fa;
    }
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
    }
    .stats-label {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .btn-primary {
        background-color: #3498db;
        border-color: #3498db;
    }
    .btn-primary:hover {
        background-color: #2980b9;
        border-color: #2980b9;
    }
    .lesson-info {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .info-icon {
        width: 30px;
        color: #3498db;
    }
    .progress-custom {
        height: 25px;
        border-radius: 15px;
    }
    .modal-header {
        background-color: #3498db;
        color: white;
    }
    .manual-attendance-form {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #3498db;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    .attendance-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .status-present {
        background-color: #d4edda;
        color: #155724;
    }
    .status-absent {
        background-color: #f8d7da;
        color: #721c24;
    }
    .status-late {
        background-color: #fff3cd;
        color: #856404;
    }
    .qr-timer {
        font-size: 1.2rem;
        font-weight: 600;
        color: #e74c3c;
    }
    .live-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        background-color: #27ae60;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-graduation-cap me-2"></i>AttendanceTracker</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher/lessons">My Lessons</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher/create-lesson">Create Lesson</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher/subjects">Subjects</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> Teacher
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile">Profile</a></li>
                            <li><a class="dropdown-item" href="/settings">Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">{{ lesson.title }}</h1>
                    <p class="mt-2 mb-0">{{ lesson.subject.subject_name }} - {{ lesson.subject.course }}</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge 
                        {% if lesson.status == 'active' %}bg-success
                        {% elif lesson.status == 'paused' %}bg-warning
                        {% elif lesson.status == 'completed' %}bg-secondary
                        {% else %}bg-primary{% endif %} status-badge">
                        {% if lesson.status == 'active' %}
                            <span class="live-indicator"></span> {{ lesson.status.title() }}
                        {% else %}
                            {{ lesson.status.title() }}
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ total_expected }}</div>
                    <div class="stats-label">Expected Students</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ total_present }}</div>
                    <div class="stats-label">Present</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ total_expected - total_present }}</div>
                    <div class="stats-label">Absent</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ "%.1f"|format(attendance_rate) }}%</div>
                    <div class="stats-label">Attendance Rate</div>
                </div>
            </div>
        </div>

        <!-- Attendance Progress -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="card-title">Attendance Progress</h6>
                <div class="progress progress-custom">
                    <div class="progress-bar" role="progressbar" style="width: {{ attendance_rate }}%">
                        {{ "%.1f"|format(attendance_rate) }}%
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">{{ total_present }} of {{ total_expected }} students have marked attendance</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Lesson Information -->
            <div class="col-md-4">
                <div class="lesson-info">
                    <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Lesson Information</h5>
                    
                    <div class="info-item">
                        <i class="fas fa-calendar info-icon"></i>
                        <span>{{ lesson.date_time.strftime('%B %d, %Y') }}</span>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas fa-clock info-icon"></i>
                        <span>{{ lesson.date_time.strftime('%I:%M %p') }} ({{ lesson.duration }} min)</span>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt info-icon"></i>
                        <span>{{ lesson.location or 'Not specified' }}</span>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas fa-key info-icon"></i>
                        <span>Backup PIN: <strong>{{ lesson.backup_pin }}</strong></span>
                    </div>
                    
                    {% if lesson.latitude and lesson.longitude %}
                    <div class="info-item">
                        <i class="fas fa-crosshairs info-icon"></i>
                        <span>Geo-fence: {{ lesson.geo_radius }}m radius</span>
                    </div>
                    {% endif %}
                    
                    {% if lesson.max_scans %}
                    <div class="info-item">
                        <i class="fas fa-redo info-icon"></i>
                        <span>Max scans: {{ lesson.max_scans }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Lesson Control Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Lesson Controls</h6>
                    </div>
                    <div class="card-body">
                        <div class="action-buttons">
                            {% if lesson.status == 'scheduled' %}
                                <form method="POST" action="/teacher/lesson/{{ lesson.id }}/activate" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-play me-1"></i>Activate
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if lesson.status == 'active' %}
                                <form method="POST" action="/teacher/lesson/{{ lesson.id }}/pause" class="d-inline">
                                    <button type="submit" class="btn btn-warning btn-sm">
                                        <i class="fas fa-pause me-1"></i>Pause
                                    </button>
                                </form>
                                
                                <form method="POST" action="/teacher/lesson/{{ lesson.id }}/extend" class="d-inline">
                                    <button type="submit" class="btn btn-info btn-sm">
                                        <i class="fas fa-plus me-1"></i>Extend 15min
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if lesson.status == 'paused' %}
                                <form method="POST" action="/teacher/lesson/{{ lesson.id }}/activate" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-play me-1"></i>Resume
                                    </button>
                                </form>
                            {% endif %}
                            
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#manualAttendanceModal">
                                <i class="fas fa-user-edit me-1"></i>Manual Entry
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-download me-2"></i>Export & Reports</h6>
                    </div>
                    <div class="card-body">
                        <div class="action-buttons">
                            <a href="/teacher/lesson/{{ lesson.id }}/export/csv" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </a>
                            <a href="/teacher/lesson/{{ lesson.id }}/export/excel" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </a>
                            <a href="/teacher/lesson/{{ lesson.id }}/export/pdf" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-file-pdf me-1"></i>PDF
                            </a>
                        </div>
                        
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#sendReportModal">
                            <i class="fas fa-envelope me-1"></i>Send Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- QR Code and Attendance -->
            <div class="col-md-8">
                {% if lesson.status == 'active' and qr_image %}
                <!-- QR Code Display -->
                <div class="qr-container mb-4">
                    <h5 class="mb-3"><i class="fas fa-qrcode me-2"></i>QR Code for Attendance</h5>
                    <img src="data:image/png;base64,{{ qr_image }}" alt="QR Code" class="qr-code">
                    <div class="mt-3">
                        <p class="text-muted">Students scan this QR code to mark attendance</p>
                        <div class="qr-timer" id="qr-timer">
                            <i class="fas fa-hourglass-half me-2"></i>
                            <span id="time-remaining">Loading...</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Attendance Table -->
                <div class="attendance-table">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Attendance Records</h5>
                        </div>
                        <div class="card-body p-0">
                            {% if attendance_records %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>Roll Number</th>
                                                <th>Status</th>
                                                <th>Scan Time</th>
                                                <th>Method</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for attendance, student, user in attendance_records %}
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="student-avatar me-2">
                                                            {{ student.full_name[0] }}
                                                        </div>
                                                        <div>
                                                            <strong>{{ student.full_name }}</strong>
                                                            <br><small class="text-muted">{{ user.email }}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>{{ student.roll_number }}</td>
                                                <td>
                                                    <span class="attendance-status status-{{ attendance.status }}">
                                                        {{ attendance.status.title() }}
                                                    </span>
                                                </td>
                                                <td>{{ attendance.scan_time.strftime('%I:%M %p') }}</td>
                                                <td>
                                                    <i class="fas fa-{{ 'qrcode' if attendance.scan_method == 'qr' else 'user-edit' }} me-1"></i>
                                                    {{ attendance.scan_method.title() }}
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                                            onclick="editAttendance({{ attendance.id }}, '{{ student.full_name }}', '{{ attendance.status }}')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                    <h6>No attendance records yet</h6>
                                    <p class="text-muted">Students haven't started marking attendance</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Expected Students Not Present -->
                {% if expected_students %}
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-user-times me-2"></i>Expected Students ({{ expected_students|length }})</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for student in expected_students %}
                                {% set student_present = attendance_records|selectattr('1.id', 'equalto', student.id)|list %}
                                {% if not student_present %}
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex align-items-center justify-content-between border p-2 rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="student-avatar me-2">
                                                {{ student.full_name[0] }}
                                            </div>
                                            <div>
                                                <strong>{{ student.full_name }}</strong>
                                                <br><small class="text-muted">{{ student.roll_number }}</small>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                onclick="quickMarkPresent({{ student.id }}, '{{ student.full_name }}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Manual Attendance Modal -->
    <div class="modal fade" id="manualAttendanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Manual Attendance Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/teacher/lesson/{{ lesson.id }}/manual-attendance">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="manual_student_id" class="form-label">Student</label>
                            <select class="form-select" id="manual_student_id" name="student_id" required>
                                <option value="">Select a student</option>
                                {% for student in expected_students %}
                                    <option value="{{ student.id }}">{{ student.full_name }} ({{ student.roll_number }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="manual_status" class="form-label">Status</label>
                            <select class="form-select" id="manual_status" name="status" required>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="late">Late</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="manual_notes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="manual_notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Attendance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Send Report Modal -->
    <div class="modal fade" id="sendReportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-envelope me-2"></i>Send Attendance Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/teacher/send-attendance-report/{{ lesson.id }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Recipients</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="academic" id="academic" name="recipients">
                                <label class="form-check-label" for="academic">Academic Staff</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="students" id="students" name="recipients">
                                <label class="form-check-label" for="students">Students</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="report_message" class="form-label">Additional Message</label>
                            <textarea class="form-control" id="report_message" name="message" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // QR Code Timer
        {% if lesson.status == 'active' and lesson.qr_expiry %}
        function updateTimer() {
            const expiryTime = new Date('{{ lesson.qr_expiry.isoformat() }}');
            const now = new Date();
            const timeLeft = expiryTime - now;
            
            if (timeLeft > 0) {
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('time-remaining').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('time-remaining').textContent = 'Expired';
                document.getElementById('qr-timer').className = 'qr-timer text-danger';
            }
        }
        
        setInterval(updateTimer, 1000);
        updateTimer();
        {% endif %}

        // Quick mark present function
        function quickMarkPresent(studentId, studentName) {
            if (confirm(`Mark ${studentName} as present?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/teacher/lesson/{{ lesson.id }}/manual-attendance';
                
                const studentInput = document.createElement('input');
                studentInput.type = 'hidden';
                studentInput.name = 'student_id';
                studentInput.value = studentId;
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                statusInput.value = 'present';
                
                const notesInput = document.createElement('input');
                notesInput.type = 'hidden';
                notesInput.name = 'notes';
                notesInput.value = 'Manually marked present by teacher';
                
                form.appendChild(studentInput);
                form.appendChild(statusInput);
                form.appendChild(notesInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Edit attendance function
        function editAttendance(attendanceId, studentName, currentStatus) {
            const newStatus = prompt(`Change attendance status for ${studentName}:\n\nCurrent: ${currentStatus}\nNew status (present/absent/late):`);
            
            if (newStatus && ['present', 'absent', 'late'].includes(newStatus.toLowerCase())) {
                // This would require additional backend endpoint to update existing attendance
                alert('Attendance update feature would be implemented here');
            }
        }

        // Auto-refresh attendance every 30 seconds for active lessons
        {% if lesson.status == 'active' %}
        setInterval(function() {
            location.reload();
        }, 30000);
        {% endif %}
    </script>
{% endblock %}