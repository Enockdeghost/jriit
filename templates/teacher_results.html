
{% extends "base.html" %}

{% block title %}My Submitted Results{% endblock %}
{% block heading %}My Submitted Results{% endblock %}

{% block header_buttons %}
<div class="d-flex">
    <div class="input-group me-2" style="width: 300px;">
        <input type="text" class="form-control" id="searchInput" placeholder="Search results...">
        <button class="btn btn-outline-primary" type="button" id="searchButton">
            <i class="fas fa-search"></i>
        </button>
    </div>
    <a href="{{ url_for('add_result') }}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i> Add New
    </a>
</div>
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Results History</h6>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                    id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-filter me-1"></i> Filter
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                <li><a class="dropdown-item filter-option" href="#" data-status="all">All Results</a></li>
                <li><a class="dropdown-item filter-option" href="#" data-status="approved">Approved</a></li>
                <li><a class="dropdown-item filter-option" href="#" data-status="pending">Pending</a></li>
                <li><a class="dropdown-item filter-option" href="#" data-status="rejected">Rejected</a></li>
            </ul>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="resultsTable" width="100%" cellspacing="0">
                <thead class="table-light">
                    <tr>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Marks</th>
                        <th>Grade</th>
                        <th>GPA</th>
                        <th>Status</th>
                        <th>Submitted At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr data-status="{{ result.Result.status|default('pending')|lower }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar me-2">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 36px; height: 36px;">
                                        {{ result.Student.full_name.split()[-1][0] }}
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ result.Student.full_name }}</div>
                                    <div class="text-muted small">{{ result.Student.student_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold">{{ result.Subject.subject_name }}</div>
                            <div class="text-muted small">{{ result.Subject.subject_code }}</div>
                        </td>
                        <td class="fw-bold">{{ result.Result.marks }}</td>
                        <td>
                            <span class="badge 
                                {% if result.Result.grade in ['A+', 'A'] %}bg-success
                                {% elif result.Result.grade in ['B+', 'B'] %}bg-info
                                {% elif result.Result.grade in ['C+', 'C'] %}bg-primary
                                {% else %}bg-danger
                                {% endif %}">
                                {{ result.Result.grade }}
                            </span>
                        </td>
                        <td class="fw-bold">{{ result.Result.gpa }}</td>
                        <td>
                            {% set status = result.Result.status|default('pending') %}
                            <span class="badge 
                                {% if status == 'approved' %}bg-success
                                {% elif status == 'rejected' %}bg-danger
                                {% else %}bg-warning text-dark
                                {% endif %}">
                                {{ status|title }}
                            </span>
                        </td>
                        <td>
                            <div>{{ result.Result.submitted_at.strftime('%d %b %Y') }}</div>
                            <div class="text-muted small">{{ result.Result.submitted_at.strftime('%I:%M %p') }}</div>
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="btn btn-sm btn-outline-primary view-comment" 
                                        data-comment="{{ result.Result.comments }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if result.Result.status != 'approved' %}
                                <a href="#" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-gray-800">No Results Submitted Yet</h5>
                                <p class="text-muted">You haven't submitted any results yet.</p>
                                <a href="{{ url_for('add_result') }}" class="btn btn-primary mt-2">
                                    <i class="fas fa-plus me-1"></i> Add Your First Result
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if results %}
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">
                Showing <span id="showingCount">{{ results|length }}</span> of {{ results|length }} results
            </div>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item"><a class="page-link" href="#">Next</a></li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Result Comments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="commentContent">No comments available</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
      
        $('.view-comment').click(function() {
            const comment = $(this).data('comment') || 'No comments available';
            $('#commentContent').text(comment);
            $('#commentModal').modal('show');
        });
        
        // Filter functionality
        $('.filter-option').click(function(e) {
            e.preventDefault();
            const status = $(this).data('status');
            const $tableRows = $('#resultsTable tbody tr');
            
            if (status === 'all') {
                $tableRows.show();
                $('#showingCount').text($tableRows.length);
                return;
            }
            
            let visibleCount = 0;
            $tableRows.each(function() {
                const rowStatus = $(this).data('status');
                if (rowStatus === status) {
                    $(this).show();
                    visibleCount++;
                } else {
                    $(this).hide();
                }
            });
            
            $('#showingCount').text(visibleCount);
        });
        
        // Search functionality
        $('#searchButton').click(searchResults);
        $('#searchInput').keypress(function(e) {
            if (e.which === 13) searchResults();
        });
        
        function searchResults() {
            const searchTerm = $('#searchInput').val().toLowerCase();
            const $tableRows = $('#resultsTable tbody tr');
            
            if (!searchTerm) {
                $tableRows.show();
                $('#showingCount').text($tableRows.length);
                return;
            }
            
            let visibleCount = 0;
            $tableRows.each(function() {
                const rowText = $(this).text().toLowerCase();
                if (rowText.includes(searchTerm)) {
                    $(this).show();
                    visibleCount++;
                } else {
                    $(this).hide();
                }
            });
            
            $('#showingCount').text(visibleCount);
        }
    });
</script>
{% endblock %}